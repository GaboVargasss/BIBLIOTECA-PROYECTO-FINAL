{% extends 'base.html' %}
{% block title %}Dashboard – Hogwarts & Books{% endblock %}

{% block extra_css %}
<style>
  /* Fondo original */
  body {
    background: url('{{ url_for("static",filename="img/fachada.jpg") }}')
                center/cover fixed;
  }
</style>
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Bienvenido {{ current_user.username or 'Visitante' }}</h2>
    {% if session.role=='guest' %}
      <a href="{{ url_for('auth') }}" class="btn btn-outline-light">Acceder</a>
    {% endif %}
  </div>

  <!-- FILTROS -->
  <form class="row g-3 mb-4">
    <div class="col-md-3">
      <input name="title" value="{{request.args.title}}" class="form-control" placeholder="Título…">
    </div>
    <div class="col-md-3">
      <input name="author" value="{{request.args.author}}" class="form-control" placeholder="Autor…">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">Todas Categorías</option>
        {% for c in categories %}
        <option value="{{ c.id }}"
            {% if request.args.category == c.id|string %}selected{% endif %}>
            {{ c.name }}
        </option>
        {% endfor %}

      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-custom w-100">Filtrar</button>
    </div>
  </form>

  <!-- INDICADORES -->
  <div class="row text-center mb-5">
    <div class="col-md-4">
      <div class="card p-3">
        <h4>Libros</h4>
        <p class="display-6">{{ total_books }}</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h4>Usuarios</h4>
        <p class="display-6">{{ total_users }}</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h4>Categorías</h4>
        <p class="display-6">{{ total_categories }}</p>
      </div>
    </div>
  </div>

  <!-- GRÁFICOS -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card p-3">
        <h5>Libros por Categoría</h5>
        <canvas id="chartCats"></canvas>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card p-3">
        <h5>Top 5 Autores</h5>
        <canvas id="chartAuth"></canvas>
      </div>
    </div>
    {% if session.role!='guest' %}
    <div class="col-12 mb-4">
      <div class="card p-3">
        <h5>Evolución Mensual de Préstamos</h5>
        <canvas id="chartLoan"></canvas>
      </div>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const catData  = {{ cat_data|tojson }};
    const authData = {{ top_auth|tojson }};
    const loanData = Array.from({length:12}, ()=>Math.floor(Math.random()*20)+5);

    new Chart(document.getElementById('chartCats'), {
      type:'doughnut',
      data:{
        labels:catData.map(o=>o.label),
        datasets:[{data:catData.map(o=>o.count)}]
      }
    });
    new Chart(document.getElementById('chartAuth'), {
      type:'bar',
      data:{
        labels:authData.map(o=>o.label),
        datasets:[{data:authData.map(o=>o.count)}]
      }
    });
    {% if session.role!='guest' %}
    new Chart(document.getElementById('chartLoan'), {
      type:'line',
      data:{
        labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets:[{
          label:'Préstamos', data:loanData, fill:false, tension:0.4
        }]
      },
      options:{animation:{duration:1500}}
    });
    {% endif %}
  </script>
{% endblock %}
